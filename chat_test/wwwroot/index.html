<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link href="style.css" rel="stylesheet" />
    <title>Chat</title>
</head>
<body>
    <header>
    </header>
    <div class="wrapper">



        <div class="chats">
            <div id="chatsList">

            </div>

            <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
            <script>

                $('body').on('click', '.chatline', function ()
                {
                    console.log('jquery_' + $(this).text());
                    document.getElementById("receiver").value = $(this).text();

                    //при нажатии на строку нужно удалить все блоки div с сообщениями, потом вызвать метод из хаба для получения сообщений

                    var allchat = document.getElementById("chatroom").children;
                    for (let i = 0; i < allchat.length; i++) {
                        allchat[i].remove();
                    }
                    
                    hubConnection.invoke("SendToLoad", $(this).text())
                        .catch(error => console.error(error));

                });

                


                






                //const li = document.getElementById("chatsList").getElementsByClassName("chatline");
                //for (let i = 0; i < li.length; i++) {
                //    li[i].addEventListener("click", () => {
                //        document.getElementById("receiver").value = "frfr";
                //    })
                //};

            </script>
        </div>



        <div class="login">
            <div id="loginBlock">
                Введите логин и пароль:<br />
                <input id="login" type="text" placeholder="Login" required/>
                <input id="username" type="text" placeholder="Username" required/>
                <input id="loginBtn" type="button" value="Войти" />
            </div><br />

            <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
            <script>
                let token;      // токен
                const hubConnection = new signalR.HubConnectionBuilder()
                    .withUrl("/chat", { accessTokenFactory: () => token })
                    .build();

                // аутентификация
                document.getElementById("loginBtn").addEventListener("click", async () => {

                    const response = await fetch("/login", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            login: document.getElementById("login").value,
                            username: document.getElementById("username").value,
                            password: "pass",
                            chats: "all admin"
                        })
                    });

                    // если запрос прошел нормально
                    if (response.ok === true) {
                        // получаем данные
                        const data = await response.json();
                        token = data.access_token;
                        username = data.username;
                        let chats = data.chats.toString();
                        

                        document.getElementById("loginBtn").disabled = true;

                        hubConnection.start()       // начинаем соединение с хабом
                            .then(() => document.getElementById("sendBtn").disabled = false)
                            .catch(err => console.error(err.toString()));

                        const elem = document.getElementById("chatsList");

                        var arr = chats.split(' ');

                        for (let i = 0; i < arr.length; i++) {
                            const e = document.createElement("p");
                            e.textContent = arr[i];
                            e.className = "chatline";
                            elem.appendChild(e);
                        }

                        

                    }
                    else {
                        // если произошла ошибка, получаем код статуса
                        console.log(`Status: ${response.status}`);
                    }
                });
            </script>

        </div>

        <div class="messages">
            <div id="chatroom"></div>

            <div id="inputForm">
                Введите сообщение и получателя:<br />
                <input type="text" id="message" placeholder="Введите сообщение" required/>
                <input type="text" id="receiver" placeholder="Введите получателя" required/>
                <input type="button" id="sendBtn" disabled value="Отправить" />
            </div>

            <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
            <script>




                // отправка сообщения от простого пользователя
                document.getElementById("sendBtn").addEventListener("click", () => {

                    const message = document.getElementById("message").value;
                    const receiver = document.getElementById("receiver").value;
                    hubConnection.invoke("Send", message, receiver)
                        .catch(error => console.error(error));
                });

                // получение сообщения от пользователя
                hubConnection.on("Receive", (message, user, msgid) => {

                    if (document.getElementById("receiver").value !== user)
                        return;

                    const block = document.createElement("div");

                    const login_name = document.getElementById("login");

                    if (login_name.value === user)
                        block.className = "msg_block_me";
                    else
                        block.className = "msg_block_another";


                    // создаем элемент <b> для имени пользователя
                    

                    // создает элемент <p> для сообщения пользователя
                    const elem = document.createElement("p");

                    const name_span = document.createElement("span");
                    name_span.className = "name_span";
                    const text_span = document.createElement("span");
                    text_span.className = "text_span";

                    name_span.textContent = `${user}: `;
                    text_span.textContent = message;

                    elem.appendChild(name_span);
                    elem.appendChild(text_span);


                    block.appendChild(elem);

                    const msg_id = document.createElement("h3");
                    msg_id.className = "id_m";
                    msg_id.textContent = msgid;

                    block.appendChild(msg_id);

                    const scroll = document.getElementById("chatroom");

                    document.getElementById("chatroom").appendChild(block);
                    scroll.scroll(0, 1000);
                });


                
                //hubConnection.on("ReceiveToLoadTest", (list) => {
                //    for (let i = 0; i < list.length; i++)
                //        console.log(list[0].text)
                //});
                

                hubConnection.on("ReceiveToLoad", (list) => {

                    for (let i = 0; i < list.length; i++) {
                        console.log(list[i].text)
                        var block = document.createElement("div");

                        var login_name = document.getElementById("login");

                        if (login_name.value === list[i].sender)
                            block.className = "msg_block_me";
                        else
                            block.className = "msg_block_another";

                        const elem = document.createElement("p");

                        const name_span = document.createElement("span");
                        name_span.className = "name_span";
                        const text_span = document.createElement("span");
                        text_span.className = "text_span";

                        name_span.textContent = `${list[i].sender}: `;
                        text_span.textContent = list[i].text;

                        elem.appendChild(name_span);
                        elem.appendChild(text_span);


                        block.appendChild(elem);

                        var msg_id = document.createElement("h3");
                        msg_id.className = "id_m";
                        msg_id.textContent = list[i].id;

                        block.appendChild(msg_id);

                        var scroll = document.getElementById("chatroom");

                        document.getElementById("chatroom").appendChild(block);
                        scroll.scroll(0, 1000);
                    }



                });





                // получени общего уведомления
                hubConnection.on("Notify", message => {

                    const elem = document.createElement("p");
                    elem.textContent = message;


                    document.getElementById("chatroom").appendChild(elem);
                });


                //скрипт для изменения сообщения
                $('body').on('click', '.msg_block_me', function () {
                    /*console.log('jquery_' + $(this).text());*/
                    var id = $(this).children("h3")[0].textContent;
                    var text = $(this).find(".text_span")[0].textContent;
                    document.getElementById("msg_id").textContent = id;
                    document.getElementById("change_text").value = text;
                    document.getElementById("changes_block").style.visibility = "visible";
                    document.getElementById("answer_btn").disabled = true;
                });

                $('body').on('click', '.msg_block_another', function () {
                    /*console.log('jquery_' + $(this).text());*/
                    document.getElementById("changes_block").style.visibility = "visible";
                    document.getElementById("change_btn").disabled = true;
                    document.getElementById("delete_btn_me").disabled = true;
                    document.getElementById("delete_btn_all").disabled = true;
                    var text = $(this).find(".text_span")[0].textContent;
                    var id = $(this).children("h3")[0].textContent;
                    document.getElementById("answer_txt").textContent = text;
                    document.getElementById("msg_id").textContent = id;
                });






            </script>

        </div>

        <div class="msg_changes" id="changes_block">

            <h3 id="msg_id"></h3>
            <div>
                <input id="change_text" type="text" placeholder="Type your message here" />
            </div>
            
            <div id="changes_buttons">
                <button id="change_btn">Change</button>
                <button id="delete_btn_me">Delete for me</button>
                <button id="delete_btn_all">Delete for all</button>
                <button id="answer_btn">Answer</button>
            </div>
            <div>
                <button id="back_btn">Back</button>
            </div>
            <p id="answer_txt"></p>
            
            <script>
                
                document.getElementById("back_btn").addEventListener("click", () => {
                    document.getElementById("change_btn").disabled = false;
                    document.getElementById("delete_btn_me").disabled = false;
                    document.getElementById("delete_btn_all").disabled = false;
                    document.getElementById("answer_btn").disabled = false;
                    document.getElementById("change_text").value = "";
                    document.getElementById("changes_block").style.visibility = "hidden";
                });

                document.getElementById("change_btn").addEventListener("click", () => {
                    let id = parseInt(document.getElementById("msg_id").textContent);
                    var rec = document.getElementById("receiver").value;
                    var text = document.getElementById("change_text").value;
                    hubConnection.invoke("Change", text, rec, id)
                        .catch(error => console.error(error));
                });


                



                hubConnection.on("ReceiveChange", (message, user, msgid) => {
                    
                    var ids = document.getElementsByClassName("id_m");
                    for (let i = 0; i < ids.length; i++) {
                        if (parseInt(ids[i].textContent) === msgid) {
                            document.getElementsByClassName("text_span")[i].textContent = message;
                        }
                    }

                });



                document.getElementById("delete_btn_all").addEventListener("click", () => {
                    let id = parseInt(document.getElementById("msg_id").textContent);
                    var rec = document.getElementById("receiver").value;
                    hubConnection.invoke("DeleteForAll", rec, id)
                        .catch(error => console.error(error));
                });

                hubConnection.on("ReceiveDeleteForAll", (user, msgid) => {

                    var ids = document.getElementsByClassName("id_m");
                    for (let i = 0; i < ids.length; i++) {
                        if (parseInt(ids[i].textContent) === msgid) {
                            let temp = document.getElementById("chatroom");
                            temp.children[i].remove();
                        }
                    }
                });

                document.getElementById("answer_btn").addEventListener("click", () => {
                    let id = parseInt(document.getElementById("msg_id").textContent);
                    let message = document.getElementById("change_text").value;
                    let receiver = document.getElementById("receiver").value;
                    let ans_text = document.getElementById("answer_txt").textContent;
                    hubConnection.invoke("Answer", message, receiver, ans_text, id)
                        .catch(error => console.error(error));
                });




                hubConnection.on("ReceiveAnswer", (message, user, msgid, answer_text) => {

                    const block = document.createElement("div");

                    const login_name = document.getElementById("login");

                    if (login_name.value === user)
                        block.className = "msg_block_me";
                    else
                        block.className = "msg_block_another";

                    const elem = document.createElement("p");

                    const name_span = document.createElement("span");
                    name_span.className = "name_span";
                    const text_span = document.createElement("span");
                    text_span.className = "text_span";

                    name_span.textContent = `${user}: `;
                    text_span.textContent = message;

                    elem.appendChild(name_span);
                    elem.appendChild(text_span);

                    const answerto = document.createElement("p");
                    answerto.className = "answer_text";
                    answerto.textContent = "Answer to: " + answer_text;

                    block.appendChild(answerto);

                    block.appendChild(elem);

                    const msg_id = document.createElement("h3");
                    msg_id.className = "id_m";
                    msg_id.textContent = msgid;

                    block.appendChild(msg_id);

                    const scroll = document.getElementById("chatroom");

                    document.getElementById("chatroom").appendChild(block);
                    scroll.scroll(0, 1000);
                });



            </script>

            

        </div>

        
    </div>
</body>
</html>